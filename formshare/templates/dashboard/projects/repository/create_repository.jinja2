{% extends 'dashboard/page.jinja2' %}
{% import 'dashboard/macros/form.jinja2' as form %}

{% block titlesection %}{{ _('Creating repository') }} {% endblock titlesection %}

{% block breadcrumbs %}
    {% include 'dashboard/projects/repository/snippets/brdcrbs_repository.jinja2' %}
{% endblock breadcrumbs %}

{% block mainsection %}
    <div class="row">
        <div class="col-md-12">
            <div  class="ibox">
                <div class="ibox-title">
                    <h5>{{ _('Reposity creator') }}</h5>
                    <div class="ibox-tools">
                        <a class="collapse-link" style="margin-right: 10px">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                        <a class="fullscreen-link">
                            <i class="fa fa-expand"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-12">
                            {% if resCode > 1  and resCode != 14 and resCode != 15%}
                                {% if errors|length > 0 %}
                                    {{ form.display_errors(errors) }}
                                {% endif %}
                            {% endif %}
                            {% if resCode != 0  %}
                                {% if resCode > 1 or get == true  %}
                                    {% if stage == 1 %}
                                        <h2>{{ _('Lets begin') }}</h2>
                                    {% endif %}
                                    {% if stage == 2 %}
                                        <h2>{{ _('Your ODK seems to be in different languages') }}</h2>
                                        {{ _('Please give us some information about them') }}
                                    {% endif %}
                                    {% if stage == 3 %}
                                        {% if hasTablesToSeparate %}
                                            <h2>Your ODK needs normalization</h2>
                                            When you create a repository your data will be stored in different tables in a database. This database is constructed based on the ODK XLSX file and depending on how big the ODK is, one or more tables might contain several columns. Usually, these many columns cut across several topics or themes, "normalization" means that <b>we need your help</b> in separating one or more "big tables" into smaller sections by topic or theme. <b>Each section must have less than 60 columns.</b>
                                        {% else %}
                                            <h2 style="color: green">Your ODK has been normalized.</h2>
                                            You can continue the process
                                        {% endif %}

                                    {% endif %}
                                    {% if stage == 4 %}
                                        {% if request.method == 'POST' %}
                                            <h2>Your ODK have duplicated options.</h2>
                                            You need to fix the below errors in the XLSX form, upload the new version and continue the process.
                                        {% else %}
                                            <h2>Your had duplicated options in your ODK.</h2>
                                            If you uploaded a new version continue the process by clicking on the "Create repository" button.
                                        {% endif %}
                                    {% endif %}
                                    {% if stage == 5 %}
                                        {% if request.method == 'POST' %}
                                            <h2>You miss some CSVs or ZIPs support files.</h2>
                                            You need to add all support CSV or ZIP files before continuing with the process.
                                        {% else %}
                                            <h2>Your <b>had</b> some missing CSVs or ZIPs.</h2>
                                            If you attached them then continue the process by clicking on the "Create repository" button.
                                        {% endif %}
                                    {% endif %}
                                    {% if stage == 6 %}
                                        {% if resCode == 14 %}
                                            {% if request.method == 'POST' %}
                                                <h2>Some of your CSVs have invalid characters.</h2>
                                                {% for key, error in error_summary.items() %}
                                                    <li data-field-label="{{ key }}">{% if key %}{{ key }}: {% endif %}{{ error }}</li>
                                                {% endfor %}
                                            {% else %}
                                                <h2>Your <b>had</b> some CSVs with invalid characters</h2>
                                                If you corrected them then continue the process by clicking on the "Create repository" button.
                                            {% endif %}
                                        {% endif %}
                                        {% if resCode == 15 %}
                                            {% if request.method == 'POST' %}
                                                <h2>An option in the XLSX has invalid characters.</h2>
                                                {% for key, error in error_summary.items() %}
                                                    <li data-field-label="{{ key }}">{% if key %}{{ key }}: {% endif %}{{ error }}</li>
                                                {% endfor %}
                                                You need to correct the XLSX form, upload the new version and continue the process.
                                            {% else %}
                                                <h2>Your <b>had</b> some CSVs with invalid characters</h2>
                                                If you corrected them then continue the process by clicking on the "Create repository" button.
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    <hr>
                                    <form id="repform" class="dataset-form form-horizontal add-member-form" method='post'>
                                        <input type="hidden" name="csrf_token" value="{{ request.session.get_csrf_token() }}">
                                        <input type="hidden" name="stage" value="{{ stage }}">
                                        {% if stage == 1 %}
                                            <div class="form-group">
                                                <label>{{ _('Which variable will be used as primary key') }}</label>
                                                <input id="primarykey" name="primarykey" type="text" class="form-control">
                                                <span style="color: #026AA8" class="form-text m-b-none">{{ _('This variable will help in controlling duplicated data') }}</span>
                                            </div>
                                        {% endif %}
                                        {% if stage == 2 %}
                                            <input id="primarykey" type="hidden" name="primarykey" value="{{ primaryKey }}">
                                            <div class="form-group">
                                                <label>{{ _('Default language') }}</label>
                                                <select style="width: 300px !important;" id="deflanguage" name="deflanguage" class="form-control">
                                                    {% for language in languages %}
                                                        <option value="{{ language.name }}" {% if language.name == deflanguage %} selected {% endif %}>{{ language.name }}</option>
                                                    {% endfor %}
                                                </select>
                                                <span style="color: #f8ac59" class="form-text m-b-none text-warning">{{ _('Please note that FormShare will store the descriptions of variables and options in the default language.') }}</span>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <b>{{ _('Language codes') }}</b><br/>
                                            <span>{{ _('You must give a code to each language. Use the ')}}<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_ISO_639-1_codes"> {{ _('ISO 639-1') }}</a> {{ _('as reference.') }}</span>
                                            <br/>
                                            <br/>
                                            {% for language in languages %}
                                                <div class="form-group">
                                                    <label>{{ _('For') }} {{ language.name }}</label>
                                                    <input class="form-control" style="width: 100px !important;" type="text" name="LNG-{{ language.name }}" value="{{ language.code }}">
                                                </div>
                                            {% endfor %}
                                            <div class="hr-line-dashed"></div>
                                            <b>{{ _('Yes and No in default language') }}</b><br/>
                                            <span class="text-danger">{{ _('Yes and No values are widely used in forms. To minimize the size of the repository we will not store variables with Yes and No as categorical variables.') }}</span>
                                            <br/>
                                            <br/>
                                            <div id="yesno">
                                                <div class="form-group">
                                                    <label>{{ _('What is "Yes" in the default language') }}</label>
                                                    <input class="form-control" id="yesvalue" type="text" name="yesvalue" value="{{ yesvalue }}" class="control-medium" style="width: 100px !important;">
                                                </div>
                                                <div class="form-group">
                                                    <label>{{ _('What is "No" in the default language') }}</label>
                                                    <input class="form-control" id="novalue" type="text" name="novalue" value="{{ novalue }}" class="control-medium" style="width: 100px !important;">
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if stage == 3 %}
                                            Tables involved:
                                            {% for table in sepTables %}
                                                {% if table.separate == true %}
                                                    <a style="color: red;" href="{{ request.route_url('separatetable', userid=userid, projcode=projcode, formid=formid,tablename=table.name,_query=qvars) }}">{{ table.name }} (needs separation)</a>
                                                {% else %}
                                                    <a href="{{ request.route_url('separatetable', userid=userid, projcode=projcode, formid=formid,tablename=table.name,_query=qvars) }}">{{ table.name }} (normalized)</a>
                                                {% endif %}
                                            {% endfor %}
                                            <input id="primarykey" type="hidden" name="primarykey" value="{{ primaryKey }}">
                                            <input id="defaultLanguage" type="hidden" name="defaultLanguage" value="{{ defaultLanguage }}">
                                            <input id="otherLanguages" type="hidden" name="otherLanguages" value="{{ otherLanguages }}">
                                            <input id="yesNoStrings" type="hidden" name="yesNoStrings" value="{{ yesNoStrings }}">
                                        {% endif %}
                                        {% if stage == 4 %}
                                            <input id="primarykey" type="hidden" name="primarykey" value="{{ primaryKey }}">
                                            <input id="defaultLanguage" type="hidden" name="defaultLanguage" value="{{ defaultLanguage }}">
                                            <input id="otherLanguages" type="hidden" name="otherLanguages" value="{{ otherLanguages }}">
                                            <input id="yesNoStrings" type="hidden" name="yesNoStrings" value="{{ yesNoStrings }}">
                                            <UL>
                                                {% for aList in listArray %}
                                                    <LI><span style="color: red">Repository table with duplicated options:</span> {{ aList.name }}
                                                        <UL>
                                                            <LI>Duplicated options
                                                                <UL>
                                                                    {% for aValue in aList['values'] %}
                                                                        <LI>{{ aValue }}</LI>
                                                                    {% endfor %}
                                                                </UL>
                                                            </LI>
                                                            <LI>Used by the following variables
                                                                <UL>
                                                                    {% for aRef in aList['references'] %}
                                                                        <LI><b>{{ aRef.variable }}</b> -- List used: {{ aRef.option }}</LI>
                                                                    {% endfor %}
                                                                </UL>
                                                            </LI>
                                                        </UL>
                                                    </LI>
                                                {% endfor %}
                                            </UL>

                                        {% endif %}
                                        {% if stage == 5 %}
                                            <input id="primarykey" type="hidden" name="primarykey" value="{{ primaryKey }}">
                                            <input id="defaultLanguage" type="hidden" name="defaultLanguage" value="{{ defaultLanguage }}">
                                            <input id="otherLanguages" type="hidden" name="otherLanguages" value="{{ otherLanguages }}">
                                            <input id="yesNoStrings" type="hidden" name="yesNoStrings" value="{{ yesNoStrings }}">
                                        {% endif %}
                                        {% if stage == 6 %}
                                            <input id="primarykey" type="hidden" name="primarykey" value="{{ primaryKey }}">
                                            <input id="defaultLanguage" type="hidden" name="defaultLanguage" value="{{ defaultLanguage }}">
                                            <input id="otherLanguages" type="hidden" name="otherLanguages" value="{{ otherLanguages }}">
                                            <input id="yesNoStrings" type="hidden" name="yesNoStrings" value="{{ yesNoStrings }}">
                                        {% endif %}
                                        <div class="form-actions">
                                            <button class="btn btn-primary"  type="submit" name="start" {% if hasTablesToSeparate == true %}disabled{% endif %}>
                                                {{ _('Create repository') }}
                                            </button>
                                        </div>
                                    </form>
                                {% else %}
                                    <h2 style="color: red">Ups! There has been an error while creating the repository</h2>
                                    We need to check your ODK. Please send the XLSX to formshare_support@qlands.com and we will get back to you as soon as possible with an explanation and a solution. In your email please use the below error code and message if any.<br/>We are sorry for the inconvenience.
                                    <h3>Error code: {{ resCode }}</h3>
                                    {% for key, error in error_summary.items() %}
                                        <li data-field-label="{{ key }}">{% if key %}{{ key }}: {% endif %}{{ error }}</li>
                                    {% endfor %}
                                {% endif %}
                            {% else %}
                                <h2 style="color: green">The repository has been created</h2>
                                You can close this page
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock mainsection %}

{% block scripts %}
    {{ super() }}
    <script>
        $(document).ready(function() {
            $('#repform').submit(function() {
                $(this).find("button[type='submit']").prop('disabled',true);
            });
        });
        </script>
{% endblock scripts %}